// -*- C++ -*-
//
// generated by wxGlade 0.7.2 (standalone edition) on Mon Nov 28 23:55:36 2016
//
// Example for compiling a single file project under Linux using g++:
//  g++ MyApp.cpp $(wx-config --libs) $(wx-config --cxxflags) -o MyApp
//
// Example for compiling a multi file project under Linux using g++:
//  g++ main.cpp $(wx-config --libs) $(wx-config --cxxflags) -o MyApp Dialog1.cpp Frame1.cpp
//
// For compilers that support precompilation, includes "wx/wx.h".
#include "wx/wxprec.h"

#ifdef __BORLANDC__
    #pragma hdrstop
#endif

#ifndef WX_PRECOMP
    #include "wx/wx.h"
    #include "wx/stockitem.h"
#endif

#include "wx/notebook.h"
#include "wx/bmpcbox.h"
#include "wx/docmdi.h"
#include "database.h"
#include "tablegeneral.h"
#include "fontpropertypagebase.h"
#include "properties.h"

const wxEventTypeTag<wxCommandEvent> wxEVT_SET_TABLE_PROPERTY( wxEVT_USER_FIRST + 1 );

PropertiesDialog::PropertiesDialog(wxWindow* parent, wxWindowID id, const wxString& title, Database *db, int type, void *object, const wxString &tableName, const wxString &schemaName, const wxPoint& pos, const wxSize& size, long style):
    wxDialog(parent, id, title, pos, size, style)
{
    std::vector<std::wstring> errors;
    m_isApplied = false;
    m_type = type;
    m_db = db;
    m_dbType = m_db->GetTableVector().m_type;
    m_object = object;
    int res = -1;
    // begin wxGlade: PropertiesDialog::PropertiesDialog
    m_properties = new wxNotebook( this, wxID_ANY );
    if( type == 0 )
    {
        wxFont *data_font, *heading_font, *label_font;
        DatabaseTable *table = static_cast<DatabaseTable *>( m_object );
        res = db->GetTableProperties( table, errors );
        bool isdataFontName = table->GetDataFontName() == L"";
        bool isheadingFontName = table->GetHeadingFontName() == L"";
        bool islabelFontName = table->GetLabelFontName() == L"";
        if( isdataFontName )
            data_font = wxFont::New( 8, wxFONTFAMILY_DEFAULT, wxFONTSTYLE_NORMAL, wxFONTWEIGHT_NORMAL, false, "MS Sans Serif" );
        else
        {
            data_font = wxFont::New( table->GetDataFontSize(), wxFONTFAMILY_DEFAULT, table->GetDataFontItalic() ? wxFONTSTYLE_ITALIC : wxFONTSTYLE_NORMAL, table->GetDataFontWeight() ? wxFONTWEIGHT_BOLD : wxFONTWEIGHT_NORMAL, table->GetDataFontUnderline(), table->GetDataFontName() );
            if( table->GetDataFontStrikethrough() )
                data_font->SetStrikethrough( true );
        }
        if( isheadingFontName )
            heading_font = wxFont::New( 8, wxFONTFAMILY_DEFAULT, wxFONTSTYLE_NORMAL, wxFONTWEIGHT_NORMAL, false, "MS Sans Serif" );
        else
        {
            heading_font = wxFont::New( table->GetHeadingFontSize(), wxFONTFAMILY_DEFAULT, table->GetHeadingFontItalic() ? wxFONTSTYLE_ITALIC : wxFONTSTYLE_NORMAL, table->GetHeadingFontWeight() ? wxFONTWEIGHT_BOLD : wxFONTWEIGHT_NORMAL, table->GetHeadingFontUnderline(), table->GetHeadingFontName() );
            if( table->GetHeadingFontStrikethrough() )
                heading_font->SetStrikethrough( true );
        }
        if( islabelFontName )
            label_font = wxFont::New( 8, wxFONTFAMILY_DEFAULT, wxFONTSTYLE_NORMAL, wxFONTWEIGHT_NORMAL, false, "MS Sans Serif" );
        else
        {
            label_font = wxFont::New( table->GetLabelFontSize(), wxFONTFAMILY_DEFAULT, table->GetLabelFontItalic() ? wxFONTSTYLE_ITALIC : wxFONTSTYLE_NORMAL, table->GetLabelFontWeight() ? wxFONTWEIGHT_BOLD : wxFONTWEIGHT_NORMAL, table->GetLabelFontUnderline(), table->GetLabelFontName() );
            if( table->GetLabelFontStrikethrough() )
                label_font->SetStrikethrough( true );
        }
        m_page1 = new TableGeneralProperty( m_properties, table, type );
        m_properties->AddPage( m_page1, _( "General" ) );
        m_page2 = new CFontPropertyPage( m_properties, data_font, isdataFontName );
        m_page3 = new CFontPropertyPage( m_properties, heading_font, isheadingFontName );
        m_page4 = new CFontPropertyPage( m_properties, label_font, islabelFontName );
        m_properties->AddPage( m_page2, _( "Data Font" ) );
        m_properties->AddPage( m_page3, _( "Heading Font" ) );
        m_properties->AddPage( m_page4, _( "Label Font" ) );
        m_page1->GetCommentCtrl()->SetFocus();
    }
    if( type == 1 )
    {
        wxString tableName = title.substr( 0, title.find( '.' ) );
        wxString fieldName = title.substr( title.find( '.' ) + 1 );
        Field *field = static_cast<Field *>( m_object );
        res = db->GetFieldProperties( tableName.ToStdWstring(), schemaName.ToStdWstring(), field->GetFieldName(), field, errors );
        if( !res )
        {
            m_page1 = new TableGeneralProperty( m_properties, field, type );
            m_properties->AddPage( m_page1, _( "General" ) );
        }
        else
        {
            for( std::vector<std::wstring>::iterator it = errors.begin(); it < errors.end(); it++ )
                wxMessageBox( (*it) );
        }
    }
    if( !res )
    {
        set_properties();
        do_layout();
        // end wxGlade
        wxButton *apply = dynamic_cast<wxButton *>( FindWindowById( wxID_APPLY ) );
        wxButton *ok = dynamic_cast<wxButton *>( FindWindowById( wxID_OK ) );
        ok->SetDefault();
        apply->Enable( false );
        apply->Bind( wxEVT_BUTTON, &PropertiesDialog::OnApply, this );
        ok->Bind( wxEVT_BUTTON, &PropertiesDialog::OnOk, this );
    }
}

void PropertiesDialog::set_properties()
{
    // begin wxGlade: PropertiesDialog::set_properties
//    SetTitle( _( "dialog_1" ) );
    // end wxGlade
}

void PropertiesDialog::do_layout()
{
    // begin wxGlade: PropertiesDialog::do_layout
    wxBoxSizer* sizer_1 = new wxBoxSizer( wxHORIZONTAL );
    wxBoxSizer* sizer_2 = new wxBoxSizer( wxVERTICAL );
    wxBoxSizer* sizer_3 = new wxBoxSizer( wxVERTICAL );
    wxSizer* buttonSizer = CreateButtonSizer( wxOK | wxCANCEL | wxAPPLY | wxHELP );
    sizer_1->Add( 5, 5, 0, wxEXPAND, 0 );
    sizer_2->Add( 5, 5, 0, wxEXPAND, 0 );
    sizer_3->Add( m_properties, 0, wxEXPAND, 0 );
    sizer_3->Add( 5, 5, 0, wxEXPAND, 0 );
    sizer_3->Add( buttonSizer, 0, wxEXPAND, 0 );
    sizer_2->Add( sizer_3, 0, wxEXPAND, 0 );
    sizer_2->Add( 5, 5, 0, wxEXPAND, 0 );
    sizer_1->Add( sizer_2, 0, wxEXPAND, 0 );
    sizer_1->Add( 5, 5, 0, wxEXPAND, 0 );
    SetSizer( sizer_1 );
    sizer_1->Fit( this );
    Layout();
    // end wxGlade
}

void PropertiesDialog::OnApply(wxCommandEvent &event)
{
    ApplyProperties();
}

void PropertiesDialog::OnOk(wxCommandEvent &event)
{
//    if( !m_isApplied && ( m_page1->IsModified() || m_page2->IsDirty() || m_page3->IsDirty() || m_page4->IsDirty() ) )
    ApplyProperties();
    EndModal( wxID_OK );
}

bool PropertiesDialog::ApplyProperties()
{
    bool exist;
    std::vector<std::wstring> errors;
    if( m_type == 0 )
    {
        if( !m_isApplied && ( m_page1->IsModified() || m_page2->IsDirty() || m_page3->IsDirty() || m_page4->IsDirty() ) )
        {
            DatabaseTable *table = static_cast<DatabaseTable *>( m_object );
/*            if( m_db->IsTablePropertiesExist( table->GetTableName(), table->GetSchemaName(), errors ) && errors.size() == 0 )
                exist = true;
            else
                exist = false;*/
            bool fontChanged = m_page2->IsDirty() && m_page3->IsDirty() && m_page4->IsDirty();
            if( !fontChanged && m_page1->IsModified() )
            {
                if( exist )
                {
                    m_command = L"UPDATE ";
                    if( m_dbType == L"SQLite" )
                        m_command += L"\"sys.abcattbl\" ";
                    else
                        m_command += L"\"abcattbl\" ";
                    m_command += L"SET ";
                    m_command += L"\"abt_cmnt\" ";
                    m_command += L"= '";
                    m_command += m_page1->GetCommentCtrl()->GetValue().ToStdWstring();
                    m_command += L"' WHERE ";
                    m_command += L"\"abt_tnam\" = '";
                    m_command += table->GetTableName();
                    m_command += L"' AND ";
                    m_command += L"\"abt_ownr\" = ";
                    if( m_dbType == L"SQLite" )
                        m_command += L"'';";
                    else
                        m_command += L"'" + table->GetSchemaName() + L"'";
                }
                else
                {
                    m_command = L"INSERT INTO ";
                    if( m_dbType == L"SQLite" )
                        m_command += L"\"sys.abcattbl\"(\"abt_tnam\", \"abt_ownr\", \"abt_cmnt\") ";
                    else
                        m_command += L"\"abcattbl\"(\"abt_tnam\", \"abt_ownr\", \"abt_cmnt\") ";
                    m_command += L"VALUES('";
                    m_command += table->GetTableName();
                    if( m_dbType == L"SQLite" )
                        m_command += L"', '', ";
                    else
                    {
                        m_command += L"', '";
                        m_command += table->GetSchemaName();
                        m_command += L"', ";
                    }
                    m_command += L"'";
                    m_command += m_page1->GetCommentCtrl()->GetValue().ToStdWstring();
                    m_command += L"'";
                    m_command += L");";
                }
            }
            else
            {
                if( exist )
                {
                    m_command = L"UPDATE ";
                    if( m_dbType == L"SQLite" )
                        m_command += L"\"sys.abcattbl\" ";
                    else
                        m_command += L"abcattbl ";
                    m_command += L"SET ";
                    m_command += L"\"abd_fhgt\" = ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetPointSize() );
                    m_command += L", \"abd_fwgt\" = ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetWeight() );
                    m_command += L", \"abd_fitl\" = ";
                    m_command += m_page2->GetFont().GetStyle() == wxFONTSTYLE_ITALIC ? L"Y" : L"N";
                    m_command += L", \"abd_funl\" = ";
                    m_command += m_page2->GetFont().GetUnderlined() ? L"Y" : L"N";
                    m_command += L", \"abd_fchr\" = ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetEncoding() );
                    m_command += L", \"abd_fptc\" = ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetPointSize() );
                    m_command += L", \"abd_ffce\" = ";
                    m_command += m_page2->GetFont().GetFaceName();
                }
                else
                {
                    m_command = L"INSERT INTO ";
                    if( m_dbType == L"SQLite" )
                        m_command += L"\"sys.abcattbl\"(\"abt_tnam\", \"abt_ownr\", \"abd_fhgt\", \"abd_fwgt\", \"abd_fitl\", \"abd_funl\", \"abd_fchr\", \"abd_fptc\", \"abd_ffce\", \"abt_cmnt\") ";
                    else
                        m_command += L"abcattbl(abt_tnam, abt_ownr, abd_fhgt, abd_fwgt, abd_fitl, abd_funl, abd_fchr, abd_fptc, abd_ffce, abt_cmnt) ";
                    m_command += L"\r\\n\tVALUES(";
                    m_command += table->GetTableName();
                    m_command += L", ";
                    m_command += table->GetSchemaName();
                    m_command += L", ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetPointSize() );
                    m_command += L", ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetWeight() );
                    m_command += L", ";
                    m_command += m_page2->GetFont().GetStyle() == wxFONTSTYLE_ITALIC ? L"Y" : L"N";
                    m_command += L", ";
                    m_command += m_page2->GetFont().GetUnderlined() ? L"Y" : L"N";
                    m_command += L", ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetEncoding() );
                    m_command += L", ";
                    m_command += wxString::Format( "%d", m_page2->GetFont().GetPointSize() );
                    m_command += L", ";
                    m_command += m_page2->GetFont().GetFaceName();
                    m_command += L");";
                }
            }
        }
    }
    if( m_type == 1 )
    {
    }
//\"abh_fhgt\" smallint, \"abh_fwgt\" smallint, \"abh_fitl\" char(1), \"abh_funl\" char(1), \"abh_fchr\" smallint, \"abh_fptc\" smallint, \"abh_ffce\" char(18), \"abl_fhgt\" smallint, \"abl_fwgt\" smallint, \"abl_fitl\" char(1), \"abl_funl\" char(1), \"abl_fchr\" smallint, \"abl_fptc\" smallint, \"abl_ffce\" char(18), \"abt_cmnt\" char(254)
    wxCommandEvent event( wxEVT_SET_TABLE_PROPERTY );
    event.SetInt( IsLogOnly() );
    event.SetExtraLong( m_type );
    event.SetClientData( &m_command );
    dynamic_cast<wxDocMDIChildFrame *>( GetParent() )->GetView()->ProcessEvent( event );
    m_isApplied = true;
    return true;
}

const std::wstring &PropertiesDialog::GetCommand()
{
    return m_command;
}

bool PropertiesDialog::IsLogOnly()
{
    return m_page1->IsLogOnly();
}
